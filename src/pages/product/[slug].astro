---
import Base from "../../layouts/Base.astro";
import Header from "../../components/Header.astro";
import Footer from "../../components/Footer.astro";
import { getProductBySlug } from "../../lib/products";

export const prerender = false;

const { slug } = Astro.params;
const product = await getProductBySlug(slug);
if (!product) {
  throw new Response(null, { status: 404, statusText: "Not found" });
}
const formatPrice = (value) =>
  value ? `$ ${value.toLocaleString("es-AR")}` : "Precio a confirmar";
const priceLabel = formatPrice(product.price);
const compareAt = product.compareAt || null;
const discount = compareAt && product.price ? Math.round(100 - (product.price / compareAt) * 100) : null;
const nameLower = product.name?.toLowerCase?.() ?? "";
const categoryLower = (product.category ?? "").toString().toLowerCase();
const kickerLabel =
  nameLower.includes("bermuda") ? "BERMUDA" :
  nameLower.includes("pantalon") ? "PANTALÓN" :
  nameLower.includes("chomba") ? "CHOMBA" :
  nameLower.includes("remera") ? "REMERA" :
  nameLower.includes("sandalia") ? "SANDALIA" :
  categoryLower === "top" ? "TOP" :
  categoryLower === "bottom" ? "BOTTOM" :
  categoryLower === "calzado" ? "CALZADO" :
  String(product.category || "").toUpperCase();

const summaryHighlights = [];
if (product.microcopy?.trim()) summaryHighlights.push(product.microcopy.trim());
if (product.fit?.trim()) summaryHighlights.push(product.fit.trim());
if (!summaryHighlights.length && product.materials?.length) summaryHighlights.push(product.materials.slice(0, 2).join(" · "));
if (summaryHighlights.length < 3 && product.colors?.length) summaryHighlights.push(product.colors.slice(0, 2).join(" · "));

const selectedSize = product.sizes?.[0] ?? "";
---

<Base title={`Fortunato | ${product.name}`} description={product.description}>
  <Header />

  <main class="pdp">
    <section class="pdp-hero">
      <img
        class="pdp-hero__img"
        src={product.images?.[0] ?? "/placeholder.svg"}
        alt={product.name}
        loading="eager"
        fetchpriority="high"
        width="1600"
        height="2000"
        decoding="async"
      />
      {product.badge ? <span class="pdp-badge">{product.badge}</span> : null}
    </section>

    <section class="pdp-summary">
      {kickerLabel ? <p class="pdp-kicker">{kickerLabel}</p> : null}
      <h1 class="pdp-title">{product.name}</h1>
      {summaryHighlights.length ? (
        <ul class="pdp-highlights">
          {summaryHighlights.slice(0, 3).map((item) => (
            <li>{item}</li>
          ))}
        </ul>
      ) : null}
    </section>

    <section class="pdp-buy">
      <div class="pdp-buy-card">
        <div class="pdp-price-stack">
          <p class="pdp-price">{priceLabel}</p>
          {compareAt ? (
            <p class="pdp-compare">
              <span class="compare-price">{formatPrice(compareAt)}</span>
              {discount ? <span class="discount-pill">{discount}% OFF</span> : null}
            </p>
          ) : null}
        </div>

        <p class="pdp-installments">3 cuotas sin interés · 6 cuotas con interés</p>

        {product.sizes?.length ? (
          <div class="pdp-field">
            <p class="pdp-label">Talles</p>
            <div class="pdp-sizes" data-size-picker>
              {product.sizes.map((size, index) => (
                <button
                  type="button"
                  class={`pdp-size-pill${index === 0 ? " is-selected" : ""}`}
                  data-size={size}
                >
                  {size}
                </button>
              ))}
            </div>
          </div>
        ) : null}

        <button
          class="btn btn-full"
          data-add-to-cart
          data-id={product.id}
          data-name={product.name}
          data-price={product.price ?? 0}
          data-currency={product.currency}
          data-image={product.images?.[0] ?? "/placeholder.svg"}
          data-size={selectedSize}
        >
          Agregar al carrito
        </button>

        <a href="/checkout" class="btn btn-ghost pdp-buy-now">Comprar ahora</a>
      </div>
    </section>

    <section class="pdp-details">
      <h2>Descripción</h2>
      <p class="muted">{product.description}</p>

      {product.materials?.length ? (
        <>
          <h2>Materiales</h2>
          <div class="pill-list">
            {product.materials.map((item) => (
              <span class="pill">{item}</span>
            ))}
          </div>
        </>
      ) : null}

      {product.colors?.length ? (
        <>
          <h2>Colores</h2>
          <div class="pill-list">
            {product.colors.map((item) => (
              <span class="pill">{item}</span>
            ))}
          </div>
        </>
      ) : null}

      {product.highlights?.length ? (
        <>
          <h2>Detalles</h2>
          <ul class="pdp-details-list">
            {product.highlights.map((item) => (
              <li>{item}</li>
            ))}
          </ul>
        </>
      ) : null}
    </section>
  </main>

  <Footer />
</Base>

<script is:inline>
  const sizePicker = document.querySelector("[data-size-picker]");
  const addButton = document.querySelector("[data-add-to-cart]");
  if (sizePicker && addButton) {
    const buttons = Array.from(sizePicker.querySelectorAll("[data-size]"));
    buttons.forEach((btn) => {
      btn.addEventListener("click", () => {
        buttons.forEach((b) => b.classList.remove("is-selected"));
        btn.classList.add("is-selected");
        addButton.dataset.size = btn.dataset.size || "";
      });
    });
  }
</script>
