---
import Base from "../../layouts/Base.astro";
import Header from "../../components/Header.astro";
import Footer from "../../components/Footer.astro";
import { getProductBySlug } from "../../lib/products";

export const prerender = false;

const { slug } = Astro.params;
const product = await getProductBySlug(slug);
if (!product) {
  throw new Response(null, { status: 404, statusText: "Not found" });
}
const formatPrice = (value) =>
  value ? `${product.currency} ${value.toLocaleString("es-AR")}` : "Precio a confirmar";
const priceLabel = formatPrice(product.price);
const compareAt = product.compareAt || null;
const discount = compareAt && product.price ? Math.round(100 - (product.price / compareAt) * 100) : null;
---

<Base title={`Fortunato | ${product.name}`} description={product.description}>
  <Header />

  <main class="product-page">
    <div class="container product-grid">
      <div>
        <img
          src={product.images?.[0] ?? "/placeholder.svg"}
          alt={product.name}
          loading="lazy"
          width="900"
          height="900"
          decoding="async"
        />
      </div>
      <div class="product-info">
        <p class="product-category">{product.category}</p>
        <h1>{product.name}</h1>
        <div class="price-stack">
          <p class="product-price">{priceLabel}</p>
          {compareAt ? (
            <p class="product-compare">
              <span class="compare-price">{formatPrice(compareAt)}</span>
              {discount ? <span class="discount-pill">{discount}% OFF</span> : null}
            </p>
          ) : null}
        </div>
        <p class="muted">{product.description}</p>

        <div class="product-meta">
          <div>
            <p class="muted">Materiales</p>
            <div class="pill-list">
              {product.materials.map((item) => (
                <span class="pill">{item}</span>
              ))}
            </div>
          </div>
          <div>
            <p class="muted">Colores</p>
            <div class="pill-list">
              {product.colors.map((item) => (
                <span class="pill">{item}</span>
              ))}
            </div>
          </div>
          <div>
            <p class="muted">Talles</p>
            <div class="pill-list">
              {product.sizes.map((item) => (
                <span class="pill">{item}</span>
              ))}
            </div>
          </div>
        </div>

        <ul class="product-highlights">
          {product.highlights.map((item) => (
            <li>â€¢ {item}</li>
          ))}
        </ul>

        <div class="product-actions" style="margin-top: 1.4rem;">
          <button
            class="btn"
            data-add-to-cart
            data-id={product.id}
            data-name={product.name}
            data-price={product.price ?? 0}
            data-currency={product.currency}
            data-image={product.images[0]}
          >
            Agregar al carrito
          </button>
          <a href="/checkout" class="btn btn-ghost">Comprar ahora</a>
        </div>
      </div>
    </div>
  </main>

  <Footer />
</Base>
